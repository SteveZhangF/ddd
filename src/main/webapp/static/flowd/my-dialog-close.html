<html lang="zh">
<head>
    <title>Work Flow Diagram</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="newcss.css">
</head>

<body>

<div class="top-panel">
    <div class="top-right-panel">
        <input type="button" class="fl-btn" id="btn-object" value="部件">
    </div>
</div>
<div class="chart-content">
    <div id="chart-container" class="chart-design droppable"></div>
    <div class="chart-right-panel">
        <div class="chart-right-list">
            <div class="chart-list chart-object">
                <h4>Component</h4>
                <div class="list-content">
                    <div class="area">
                        <div class="draggable" id="rect">文本</div>
                        <div class="draggable roundedRect" id="roundedRect">文本</div>
                        <div class="draggable circle" id="circle">文本</div>
                        <div class="draggable rhombus" id="rhombus">文本</div>
                    </div>
                </div>
                <h4>Forms</h4>
                <div class="list-content">
                    <div class="form-list">
                        <ul>
                            <li class="draggable-list">ss</li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="chart-ratio">
        <input id="rear-ratio" class="chart-ratio-form" value="100" min="50" max="300" placeholder="10"
               type="range"
               onchange="ratioDisplay()" step="10">

        <div class="rare-ratio">
            <input id="rear-ratio-display" class="chart-ratio-form" value="100" width="40" min="50" max="300"
                   placeholder="10" type="number" onchange="ratioDisplay2()" step="10">
        </div>
        <div class="chart-ratio-cover"></div>
    </div>
</div>

<script src="../lib/jquery/dist/jquery.js"></script>
<script src="../lib/jquery-ui/jquery-ui.js"></script>
<script src="../lib/jsPlumb/dist/js/jsPlumb-2.0.2.js"></script>
<script type="text/javascript">

    //标识右侧工具栏是否已显示,默认显示
    sessionStorage['rightToolsIsDisplay'] = true;
    //标识当前点击的流程图框,默认为none
    sessionStorage['currentChartSelected'] = 'none';

    //记录当前流程框的数量
    sessionStorage['currentChartAmount'] = 0;
    //指定流程图设计区域宽度高度
    function adjustDesignWidth() {
        var designWidth = 0;
        var domWidth = $(window).width();
        designWidth = domWidth - $('.chart-right-panel').width();
        $('.chart-design').css('width', designWidth - 4);
    }

    /**
     * for zoom in out
     * */
    //对页面进行缩小或放大
    function setZoom(instance, scale, container) {
        //jsPlumb.setContainer("chart-container");
        $("#" + container).css({
            "-webkit-transform": "scale(" + scale + ")",
            "-moz-transform": "scale(" + scale + ")",
            "-ms-transform": "scale(" + scale + ")",
            "-o-transform": "scale(" + scale + ")",
            "transform": "scale(" + scale + ")",
            "TransformOrigin": "0% 0%"
        });
        instance.setZoom(scale);
    }
    //滑动条改变时触发的事件
    function ratioDisplay() {
        var chartRatioDom = document.getElementById('rear-ratio');
        var chartRatioDisplayDom = document.getElementById('rear-ratio-display');
        chartRatioDisplayDom.value = chartRatioDom.value;
        setZoom(jsPlumb, chartRatioDom.value / 100, 'chart-container');
        $('#chart-container').css({
            'left': '0px',
            'right': '180px'
        });
    }
    //大小选择框值改变时触发
    function ratioDisplay2() {
        var chartRatioDisplayDom = document.getElementById('rear-ratio-display');
        var chartRatioDom = document.getElementById('rear-ratio');
        chartRatioDom.value = chartRatioDisplayDom.value;
        setZoom(jsPlumb, chartRatioDisplayDom.value / 100, 'chart-container');
        $('#chart-container').css({
            'left': '0px',
            'right': '180px'
        });
    }
    /**
     * zoom in out end
     * */

    //负责属性面板的切换,
    //参数will代表即将要切换的属性面板[text|object|style]
    //参数current代表当前属性面板,可由getChartRightListFlag()获得
    function attrToggle() {
        if (sessionStorage['rightToolsIsDisplay'] == 'false') {
            $('.chart-right-panel').show();
            sessionStorage['rightToolsIsDisplay'] = true;
            $('.chart-design').css("right", "230px");
        } else {
            $('.chart-right-panel').hide();
            sessionStorage['rightToolsIsDisplay'] = false;
        }
    }
    //****************负责属性面板的内容设置*****************

    //****************负责属性面板的内容设置*****************
    //*********************************jsPlumb基础信息配置区域*********************************
    //流程图ID唯一标识,用来防止重复,每次新建一个部件时此值必须加1,否则会出现异常
    sessionStorage['idIndex'] = 0;
    //检测设计区域中间区域是否被占据,页面刚加载时默认没有被占据
    sessionStorage['midIsOccupied'] = 'not';
    //根蒂根基连接线样式
    var connectorPaintStyle = {
        lineWidth: 4,
        strokeStyle: "rgb(0,32,80)",
        joinstyle: "round",
        outlineColor: "rgb(251,251,251)",
        outlineWidth: 2
    };
    // 鼠标悬浮在连接线上的样式
    var connectorHoverStyle = {
        lineWidth: 4,
        strokeStyle: "#216477",
        outlineWidth: 0,
        outlineColor: "rgb(251,251,251)"
    };
    var hollowCircle = {
        endpoint: ["Dot", {radius: 8}],  //端点的外形
        connectorStyle: connectorPaintStyle,//连接线的色彩,大小样式
        connectorHoverStyle: connectorHoverStyle,
        paintStyle: {
            strokeStyle: "rgb(0,32,80)",
            fillStyle: "rgb(0,32,80)",
            opacity: 0.5,
            radius: 2,
            lineWidth: 2
        },//端点的色彩样式
        //anchor: "AutoDefault",
        isSource: true,    //是否可以拖动(作为连线出发点)
        connector: ["Flowchart", {stub: [40, 60], gap: 10, cornerRadius: 5, alwaysRespectStubs: true}],  //连接线的样式种类有[Bezier],[Flowchart],[StateMachine ],[Straight ]
        // connector: ["Bezier", { curviness:100 } ],//设置连线为贝塞尔曲线
        isTarget: true,    //是否可以放置(连线终点)
        maxConnections: -1,    // 设置连接点最多可以连接几条线
        connectorOverlays: [["Arrow", {width: 10, length: 10, location: 1}]]
    };


    //*********************************流程图数据操作区域*********************************
    var list = [];//全部的连接点列表
    //序列化全部流程图数据,json格式
    function save() {
        var connects = [];
        for (var i in list) {
            for (var j in list[i]) {
                connects.push({
                    ConnectionId: list[i][j]['id'],
                    PageSourceId: list[i][j]['sourceId'],
                    PageTargetId: list[i][j]['targetId']
                });
            }
        }
        var blocks = [];
        $(".droppable .draggable").each(function (idx, elem) {
            var elem = $(elem);
            var rareHTML = elem.html();
            var resultHTML = rareHTML;
            //去掉在进行复制操作时误复制的img部件
            if (rareHTML.indexOf('<img src=\"img/delete.png\"') != -1) {
                rareHTML = rareHTML.split('<img src=\"img/delete.png\"');
                resultHTML = rareHTML[0];
            }
            if (resultHTML.indexOf('<div style="z-index: 90;" ') != -1) {
                resultHTML = resultHTML.split('<div style="z-index: 90;" ')[0];
            }
            /**********************字体**********************/
            //字体
            var Bfont = elem.css("font");
            //字体颜色
            var fontSize = elem.css('font-size');
            //字体对齐方式
            var fontAlign = elem.css('text-align');
            //字体颜色
            var fontColor = elem.css('color');
            (Bfont == '') ? Bfont = "微软雅黑" : Bfont;
            (fontSize == '') ? fontSize = '12' : fontSize;
            (fontAlign == '') ? fontAlign = 'center' : fontAlign;
            (fontColor == '') ? fontColor = 'rgb(0,0,0)' : fontColor;
            /**********************物件**********************/
            //圆角
            var borderRadius = elem.css('borderRadius');
            var elemType = elem.attr('id').split('-')[0];
            (borderRadius == '') ? borderRadius = '0' : borderRadius;
            //如果当前部件是圆角矩形,且borderRadius为空或者为0就把默认borderradius设置为4,下同
            (elemType == 'roundedRect' && (borderRadius == '' || borderRadius == '0')) ? borderRadius = '4' : borderRadius;
            (elemType == 'circle' && (borderRadius == '' || borderRadius == '0')) ? borderRadius = '15' : borderRadius;
            //填充
            var fillColor = elem.css('backgroundColor');
            (fillColor == '') ? fillColor = 'rgb(255,255,255)' : fillColor;
            //渐近度
            var fillBlurRange = elem.css('boxShadow');//rgb(0, 0, 0) 10px 10px 17px 20px inset
            var fillBlurSplit = fillBlurRange.split(' ');
            (fillBlurRange == '') ? fillBlurRange = '0' : fillBlurRange = fillBlurSplit[5];
            //渐近色
            var fillBlurColor = fillBlurSplit[0] + fillBlurSplit[1] + fillBlurSplit[2];
            //线框样式
            var borderStyle = elem.css('border-left-style');
            (borderStyle == '') ? borderStyle = 'solid' : borderStyle;
            //线框宽度
            var borderWidth = elem.css('border-left-width');
            (borderWidth == '') ? borderWidth = '2' : borderWidth.split('px')[0];
            //线框颜色
            var borderColor = elem.css('border-left-color');
            (borderColor == '') ? borderColor = 'rgb(136,242,75)' : borderColor;
            //阴影数据
            var shadow = elem.css('box-shadow');
            //字体样式数据
            var fontStyle = elem.css('fontStyle');
            var fontWeight = elem.css('fontWeight');
            var fontUnderline = elem.css('textDecoration');
            //文字高度
            var lineHeight = elem.css('line-height');
            blocks.push({
                BlockId: elem.attr('id'),
                BlockContent: resultHTML,
                BlockX: parseInt(elem.css("left"), 10),
                BlockY: parseInt(elem.css("top"), 10),
                BlockWidth: parseInt(elem.css("width"), 10),
                BlockHeight: parseInt(elem.css("height"), 10),
                BlockFont: Bfont,
                BlockFontSize: fontSize,
                BlockFontAlign: fontAlign,
                BlockFontColor: fontColor,
                BlockBorderRadius: borderRadius,
                BlockBackground: fillColor,
                BlockFillBlurRange: fillBlurRange,
                BlockFillBlurColor: fillBlurColor,
                BlockBorderStyle: borderStyle,
                BlockBorderWidth: borderWidth,
                BlockborderColor: borderColor,
                BlockShadow: shadow,
                BlockFontStyle: fontStyle,
                BlockFontWeight: fontWeight,
                BlockFontUnderline: fontUnderline,
                BlockLineHeight: lineHeight
            });
        });
        var serliza = "{" + '"connects":' + JSON.stringify(connects) + ',"block":' + JSON.stringify(blocks) + "}";
//        console.log(serliza);
        return serliza;
    }
    //生成单个流程图数据,用在新建流程图框时使用
    //参数ID表示被push进栈的ID
    function getSingleChartJson(id) {
        var connects = [];
        for (var i in list) {
            for (var j in list[i]) {
                connects.push({
                    ConnectionId: list[i][j]['id'],
                    PageSourceId: list[i][j]['sourceId'],
                    PageTargetId: list[i][j]['targetId'],
                });
            }
        }
        var blocks = [];
        var elem = $("#" + id);
        var rareHTML = elem.html();
        var resultHTML = rareHTML;
        //console.log(rareHTML);
        //去掉在进行复制操作时误复制的img部件
        if (rareHTML.indexOf('<img src=\"img/delete.png\"') != -1) {
            rareHTML = rareHTML.split('<img src=\"img/delete.png\"');
            resultHTML = rareHTML[0];
        }
        if (resultHTML.indexOf('<div style="z-index: 90;" ') != -1) {
            resultHTML = resultHTML.split('<div style="z-index: 90;" ')[0];
        }
        /**********************字体**********************/
        //字体
        var Bfont = elem.css("font");
        //字体颜色
        var fontSize = elem.css('font-size');
        //字体对齐方式
        var fontAlign = elem.css('text-align');
        //字体颜色
        var fontColor = elem.css('color');
        (Bfont == '') ? Bfont = "微软雅黑" : Bfont;
        (fontSize == '') ? fontSize = '12' : fontSize;
        (fontAlign == '') ? fontAlign = 'center' : fontAlign;
        (fontColor == '') ? fontColor = 'rgb(0,0,0)' : fontColor;
        /**********************物件**********************/
        //圆角
        var borderRadius = elem.css('borderRadius');
        var elemType = id.split('-')[0];
        (borderRadius == '') ? borderRadius = '0' : borderRadius;
        //如果当前部件是圆角矩形,且borderRadius为空或者为0就把默认borderradius设置为4,下同
        (elemType == 'roundedRect' && (borderRadius == '' || borderRadius == '0')) ? borderRadius = '4' : borderRadius;
        (elemType == 'circle' && (borderRadius == '' || borderRadius == '0')) ? borderRadius = '15' : borderRadius;
        //填充
        var fillColor = elem.css('backgroundColor');
        (fillColor == '') ? fillColor = 'rgb(255,255,255)' : fillColor;
        //渐近度
        var fillBlurRange = elem.css('boxShadow');//rgb(0, 0, 0) 10px 10px 17px 20px inset
        var fillBlurSplit = fillBlurRange.split(' ');
        (fillBlurRange == '') ? fillBlurRange = '0' : fillBlurRange = fillBlurSplit[5];
        //渐近色
        var fillBlurColor = fillBlurSplit[0] + fillBlurSplit[1] + fillBlurSplit[2];
        //线框样式
        var borderStyle = elem.css('border-left-style');
        (borderStyle == '') ? borderStyle = 'solid' : borderStyle;
        //线框宽度
        var borderWidth = elem.css('border-left-width');
        (borderWidth == '') ? borderWidth = '2' : borderWidth.split('px')[0];
        //线框颜色
        var borderColor = elem.css('border-left-color');
        (borderColor == '') ? borderColor = 'rgb(136,242,75)' : borderColor;
        //阴影数据
        var shadow = elem.css('box-shadow');
        //字体样式数据
        var fontStyle = elem.css('fontStyle');
        var fontWeight = elem.css('fontWeight');
        var fontUnderline = elem.css('textDecoration');
        //文字高度
        var lineHeight = elem.css('line-height');
        blocks.push({
            BlockId: elem.attr('id'),
            BlockContent: resultHTML,
            BlockX: parseInt(elem.css("left"), 10),
            BlockY: parseInt(elem.css("top"), 10),
            BlockWidth: parseInt(elem.css("width"), 10),
            BlockHeight: parseInt(elem.css("height"), 10),
            BlockFont: Bfont,
            BlockFontSize: fontSize,
            BlockFontAlign: fontAlign,
            BlockFontColor: fontColor,
            BlockBorderRadius: borderRadius,
            BlockBackground: fillColor,
            BlockFillBlurRange: fillBlurRange,
            BlockFillBlurColor: fillBlurColor,
            BlockBorderStyle: borderStyle,
            BlockBorderWidth: borderWidth,
            BlockborderColor: borderColor,
            BlockShadow: shadow,
            BlockFontStyle: fontStyle,
            BlockFontWeight: fontWeight,
            BlockFontUnderline: fontUnderline,
            BlockLineHeight: lineHeight
        });
        var serliza = "{" + '"connects":' + JSON.stringify(connects) + ',"block":' + JSON.stringify(blocks) + "}";
        console.log(serliza);
        return serliza;
    }
    //双击修改文本
    function changeValue(id) {
        $(id).dblclick(function () {
            var text = $(this).text();
            $(this).html("");
            $(this).append("<input class=\"chart-text-edit\" type=\"text\" value=\"" + text + "\" />");
            $(this).mouseleave(function () {
                $(this).html($(".chart-text-edit").val());
            });
        });
    }
    //新增一个部件
    //参数newChartArea代表新增部件的区域
    //参数chartID代表新流程图部件的ID,格式为元素名称-index
    //参数left,top代表新部件的插入位置
    //参数blockName代表新部件的文本
    //参数undo表示是否进行撤销操作,如果进行撤销操作则不进行入栈,默认为false
    function addNewChart(newChartArea, chartID, left, top, blockName, undo) {
        undo = (undo == '') ? false : arguments[5];
        var name = chartID.split('-')[0];
        //在div内append元素
        $(newChartArea).append("<div class=\"draggable " + name + " new-" + name + "\" id=\"" + chartID + "\">" + blockName + "</div>");
        $("#" + chartID).css("left", left).css("top", top).css("position", "absolute").css("margin", "0px");
        //用jsPlumb添加锚点
        jsPlumb.addEndpoint(chartID, {anchors: "TopCenter"}, hollowCircle);
        jsPlumb.addEndpoint(chartID, {anchors: "RightMiddle"}, hollowCircle);
        jsPlumb.addEndpoint(chartID, {anchors: "BottomCenter"}, hollowCircle);
        jsPlumb.addEndpoint(chartID, {anchors: "LeftMiddle"}, hollowCircle);
        jsPlumb.draggable(chartID);
        $("#" + chartID).draggable({containment: "parent"});//保证拖动不跨界
        sessionStorage['idIndex'] = sessionStorage['idIndex'] + 1;
        changeValue("#" + chartID);
    }
    //通过json加载流程图
    function loadChartByJSON(data) {
        var unpack = JSON.parse(data);
        if (!unpack) {
            return false;
        }
        /*flowConnector={
         anchors:["BottomCenter","TopCenter"],
         endpoints:["dot","blank"]
         };*/
        for (var i = 0; i < unpack['block'].length; i++) {
            var BlockId = unpack['block'][i]['BlockId'];
            var BlockContent = unpack['block'][i]['BlockContent'];
            var BlockX = unpack['block'][i]['BlockX'];
            var BlockY = unpack['block'][i]['BlockY'];
            var width = unpack['block'][i]['BlockWidth'];
            var height = unpack['block'][i]['BlockHeight'];
            var font = unpack['block'][i]['BlockFont'];
            var fontSize = unpack['block'][i]['BlockFontSize'];
            var fontAlign = unpack['block'][i]['BlockFontAlign'];
            var fontColor = unpack['block'][i]['BlockFontColor'];
            var borderRadius = unpack['block'][i]['BlockBorderRadius'];
            var backgroundColor = unpack['block'][i]['BlockBackground'];
            var fillBlurRange = unpack['block'][i]['BlockFillBlurRange'];
            var fillBlurColor = unpack['block'][i]['BlockFillBlurColor'];
            var borderStyle = unpack['block'][i]['BlockBorderStyle'];
            var borderColor = unpack['block'][i]['BlockborderColor'];
            var shadow = unpack['block'][i]['BlockShadow'];
            var fontStyle = unpack['block'][i]['BlockFontStyle'];
            var fontWeight = unpack['block'][i]['BlockFontWeight'];
            var fontUnderline = unpack['block'][i]['BlockFontUnderline'];
            var lineHeight = unpack['block'][i]['BlockLineHeight'];
            var blockAttr = BlockId.split('-')[0];
            var boxInsetShadowStyle = '10px 10px ' + fillBlurRange + "px 20px " + fillBlurColor + ' inset';
            $('.chart-design').append("<div class=\"draggable " + blockAttr + " new-" + blockAttr + "\" id=\"" + BlockId + "\">" + BlockContent + "</div>");
            $("#" + BlockId)
                    .css("left", BlockX)
                    .css("top", BlockY)
                    .css("position", "absolute")
                    .css("margin", "0px")
                    .css("width", width)
                    .css("height", height)
                    .css('font', font)
                    .css('font-size', fontSize)
                    .css('text-align', fontAlign)
                    .css('color', fontColor)
                    .css('border-radius', borderRadius)
                    .css('background', backgroundColor)
                    .css('box-shadow', boxInsetShadowStyle)
                    .css('border-style', borderStyle)
                    .css('border-color', borderColor)
                    .css('box-shadow', shadow)
                    .css('font-style', fontStyle)
                    .css('font-weight', fontWeight)
                    .css('font-underline', fontUnderline)
                    .css('line-height', lineHeight);
        }
        /*for(i=0;i<unpack['connects'].length;i++){
         var ConnectionId=unpack['connects'][i]['ConnectionId'];
         var PageSourceId=unpack['connects'][i]['PageSourceId'];
         var PageTargetId=unpack['connects'][i]['PageTargetId'];
         //用jsPlumb添加锚点
         jsPlumb.addEndpoint(PageSourceId,{anchors: "TopCenter"},hollowCircle);
         jsPlumb.addEndpoint(PageSourceId,{anchors: "RightMiddle"},hollowCircle);
         jsPlumb.addEndpoint(PageSourceId,{anchors: "BottomCenter"},hollowCircle);
         jsPlumb.addEndpoint(PageSourceId,{anchors: "LeftMiddle"},hollowCircle);
         jsPlumb.addEndpoint(PageTargetId,{anchors: "TopCenter"},hollowCircle);
         jsPlumb.addEndpoint(PageTargetId,{anchors: "RightMiddle"},hollowCircle);
         jsPlumb.addEndpoint(PageTargetId,{anchors: "BottomCenter"},hollowCircle);
         jsPlumb.addEndpoint(PageTargetId,{anchors: "LeftMiddle"},hollowCircle);
         jsPlumb.draggable(PageSourceId);
         jsPlumb.draggable(PageTargetId);
         $("#"+PageSourceId).draggable({containment: "parent"});//保证拖动不跨界
         $("#"+PageTargetId).draggable({containment: "parent"});//保证拖动不跨界
         jsPlumb.connect({
         source:PageSourceId,target:PageTargetId},
         flowConnector);
         }*/
        return true;
    }
    //loadChartByJSON('{"connects":[],"block":[{"BlockId":"rect-01","BlockContent":"文本","BlockX":648,"BlockY":40,"BlockWidth":120,"BlockHeight":120,"BlockFont":"微软雅黑","BlockFontSize":"60px","BlockFontAlign":"center","BlockFontColor":"rgb(255, 255, 255)","BlockBorderRadius":"0","BlockBackground":"rgb(128, 0, 255)","BlockFillBlurRange":"85px","BlockFillBlurColor":"rgb(0,0,0)","BlockBorderStyle":"dashed","BlockBorderWidth":"2px","BlockborderColor":"rgb(136, 242, 75)","BlockShadow":"rgb(0, 0, 0) 30px 51px 85px 0px"},{"BlockId":"roundedRect-0111","BlockContent":"文本","BlockX":464,"BlockY":94,"BlockWidth":120,"BlockHeight":20,"BlockFont":"微软雅黑","BlockFontSize":"12px","BlockFontAlign":"center","BlockFontColor":"rgb(0, 0, 0)","BlockBorderRadius":"4","BlockBackground":"rgb(128, 0, 255)","BlockFillBlurColor":"noneundefinedundefined","BlockBorderStyle":"solid","BlockBorderWidth":"2px","BlockborderColor":"rgb(136, 242, 75)","BlockShadow":"none"}]}');
    //sessionStorage['currentChartAmount']=sessionStorage['currentChartAmount']+2;
    //删除一个流程框图,若参数undo为true则在进行操作时不进行入栈操作,默认为false
    function deleteChart(id) {
        var DOM = $('#' + id);
        jsPlumb.removeAllEndpoints(id);
        DOM.remove();
    }

    //*********************************流程图数据操作区域*********************************
    $(document).ready(function () {
        //**************************************UI控制部分***************************************
        //初始化动画效果
        $('.chart-ratio-form,.chart-fill-border-selector,#chart-v-shadow-display,#chart-h-shadow-display,#chart-blur-range-display,#chart-shadow-blur-display,#chart-shadow-color-display,#chart-shadow-spread-display').css("opacity", '0.6');
        //隐藏右侧属性面板
        //$('.chart-right-panel').hide();
        //为按钮,列表添加动画效果
        $('.fl-btn,h4').hover(
                function () {
                    $(this).stop().animate({opacity: 0.5}, 'fast');
                },
                function () {
                    $(this).stop().animate({opacity: 1}, 'fast');
                }
        );
        //为左下角大小调节添加动画效果
        $('.chart-ratio-form,.chart-fill-border-selector,#chart-v-shadow-display,#chart-h-shadow-display,#chart-blur-range-display,#chart-shadow-blur-display,#chart-shadow-color-display,#chart-shadow-spread-display').hover(
                function () {
                    $(this).stop().animate({opacity: 1}, 'fast');
                },
                function () {
                    $(this).stop().animate({opacity: 0.6}, 'fast');
                }
        );
        //给左侧工具栏分页
        $(".chart-object").accordion();
        //调节区域双击可输入数字更改
        $('.rare-ratio').dblclick(function () {
            var chartRatioValue = document.getElementById('rear-ratio').value;
        });
        //页面上方按钮事件

        //标识线条选择器有没有被展开,默认不展开
        sessionStorage['topLineSelectIsDisplayed'] = false;
        //标识排列选择器有没有被展开,默认不展开
        sessionStorage['topAlignSelectIsDisplayed'] = false;
        //对页面上方的工具菜单进行折叠
        function selectorToggle(event, element) {
            //取消事件冒泡
            event.stopPropagation();
            //设置弹出层的位置
            var offset = $(event.target).offset();
            $(element).css({
                top: offset.top + $(event.target).height() + "px",
                left: offset.left
            });
            //按钮的toggle,如果div是可见的,点击按钮切换为隐藏的;如果是隐藏的,切换为可见的。
            $(element).toggle('fast');
        }

        //上方工具栏的按钮点击事件
        $('.fl-btn').click(function (event) {
            attrToggle();
        });

        //**************************************UI控制部分***************************************
        //***********************************元素拖动控制部分************************************
        //允许元素拖动
        $(".list-content .area").children().draggable({
            //revert: "valid",//拖动之后原路返回
            helper: "clone",//复制自身
            scope: "dragflag"//标识
        });
        $(".list-content .form-list").children().draggable({
            //revert: "valid",//拖动之后原路返回
            helper: "clone",//复制自身
            scope: "dragflag"//标识
        });

        $(".droppable").droppable({
            accept: ".draggable", //只接受来自类.dragable的元素
            activeClass: "drop-active", //开始拖动时放置区域显示
            scope: "dragflag",
            drop: function (event, ui) {
                sessionStorage['idIndex'] = sessionStorage['idIndex'] + 1;
                //获取鼠标坐标
                var left = parseInt(ui.offset.left - $(this).offset().left);
                var top = parseInt(ui.offset.top - $(this).offset().top) + 4;
                setChartLocation(top, left);//设置坐标

                var name = ui.draggable[0].id;//返回被拖动元素的ID
                var trueId = name + "-" + sessionStorage['idIndex'] + sessionStorage['currentChartAmount'];
                //在div内append元素
                $(this).append("<div class=\"draggable " + name + " new-" + name + "\" id=\"" + trueId + "\">" + $(ui.helper).html() + "</div>");
                $("#" + trueId).css("left", left).css("top", top).css("position", "absolute").css("margin", "0px");
                //用jsPlumb添加锚点
                jsPlumb.addEndpoint(trueId, {anchors: "TopCenter"}, hollowCircle);
                jsPlumb.addEndpoint(trueId, {anchors: "RightMiddle"}, hollowCircle);
                jsPlumb.addEndpoint(trueId, {anchors: "BottomCenter"}, hollowCircle);
                jsPlumb.addEndpoint(trueId, {anchors: "LeftMiddle"}, hollowCircle);
                jsPlumb.draggable(trueId);
                $("#" + trueId).draggable({containment: "parent"});//保证拖动不跨界
                changeValue("#" + trueId);
                list = jsPlumb.getAllConnections();//获取所有的连接
                //元素ID网上加,防止重复
                sessionStorage['idIndex'] = sessionStorage['idIndex'] + 1;
                //设置当前选择的流程框图
                sessionStorage['currentChartSelected'] = trueId;
                //将新拖进来的流程图框JSON数据push进栈
                //chartOperationStack['add'].push(getSingleChartJson(trueId));
                //chartRareOperationStack.push('add');
                sessionStorage['currentChartAmount'] = parseInt(sessionStorage['currentChartAmount'], 10) + 2;
            }
        });
        $('.droppable .draggable').resizable({
            ghost: true
        });
        //删除元素按钮
        $(".droppable").on("mouseenter", ".draggable", function () {
            $(this).append("<img src=\"img\/delete.png\" id=\"fuck\" style=\"position:absolute;width:20px;height:16px;\"/>");

            //因为流程图的形状不一样,所以要获取特定的流程图名称来指定删除按钮的位置
            var wholeID = $(this).attr('id');
            var wholeIDSep = wholeID.split('-');
            if (wholeIDSep[0] == "circle") {
                $("img").css("left", $(this).width() - 20).css("top", 20);
            } else if (wholeIDSep[0] == "rhombus") {
                $("img").css("left", $(this).width() - 18).css("top", 10);
            } else {
                $("img").css("left", $(this).width() - 20).css("top", 10);
            }
        });
        $(".droppable").on("mouseleave", ".draggable", function () {
            $("img").remove();
        });
        $(".droppable").on("click", "img", function () {
            //要先保存父元素的DOM,因为出现确认对话框之后(this)会消失
            var parentDOM = $(this).parent();
            var parentID = parentDOM.attr('id');
            if (confirm("确定要删除吗?")) {
                // chartOperationStack['delete'].push(getSingleChartJson(parentID));
                jsPlumb.removeAllEndpoints(parentID);
                parentDOM.remove();
                //chartRareOperationStack.push('delete');
            }
        });

        //设计区域被双击时
        $('.droppable').on('dblclick', function () {
            sessionStorage['currentChartSelected'] = 'none';//置当前选择的流程图框为空
            $('#B,#I,#U').removeClass('fl-font-style-active');//置当前字体样式选择器为空
            $('#btn-align-center,#btn-align-left,#btn-align-right,#btn-align-none').removeClass('fl-align-style-active');//置当前对齐方式为空
        });
        //设计区域元素被拖动时,触发同步坐标
        /*$(".droppable").droppable({
         activate:function(event,ui){
         console.log('sdsd');
         //console.log(this);
         setChartLocation($(this).offset().top,$(this).offset().left);
         }
         });*/
        $(".draggable").draggable({
            start: function () {
                console.log('start');
            },
            drag: function () {
                console.log('drag');
            },
            stop: function () {
                console.log('stop');
            }
        });

        ////目标选择框文本发生更改时触发的事件,根据ID不同

        //$(".chart-fill-border-selector option:selected").attr('value')
        //*****************右侧属性面板内容改变同步到设计区域******************
        //删除连接线
        jsPlumb.bind("click", function (conn, originalEvent) {
            if (confirm("确定删除吗?")) {
                jsPlumb.detach(conn);
            }
        });
        //DOCUMENT快捷键操作
        $(document).on("keydown", function (event) {
            if (event.which == 46) {
                //DELETE 进行删除部件操作
                if (sessionStorage['currentChartSelected'] != 'none') {
                    if (confirm("确定要删除吗?")) {
                        deleteChart(sessionStorage['currentChartSelected']);
                        setChartLocation(0, 0);
                        setChartSize(0, 0);
                    }
                }
            }
        });

        //点击空白处或者自身隐藏弹出层，下面分别为滑动和淡出效果。
        $(document).click(function (event) {
            $('.line-select').slideUp('fast');
            sessionStorage['topLineSelectIsDisplayed'] = false;
            sessionStorage['topAlignSelectIsDisplayed'] = false;
        });
        //***********************************元素拖动控制部分************************************
    })
    ;
</script>
</body>
</html>